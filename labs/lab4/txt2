import boto3
import requests
import argparse
def download_file(url, local_filename):
    """Download a file from a URL and save it locally."""
    response = requests.get(url, stream=True)
    if response.status_code == 200:
        with open(local_filename, "wb") as file:
            for chunk in response.iter_content(1024):
                file.write(chunk)
        print(f"Downloaded {local_filename} from {url}")
        return local_filename
    else:
        print(f"Failed to download file. HTTP Status: {response.status_code}")
        exit(1)
def upload_to_s3(file_name, bucket_name):
    """Upload a file to an S3 bucket."""
    s3 = boto3.client("s3")
    try:
        s3.upload_file(file_name, bucket_name, file_name)
        print(f"Uploaded {file_name} to s3://{bucket_name}/{file_name}")
        return True
    except Exception as e:
        print(f"Upload failed: {e}")
        exit(1)
def generate_presigned_url(bucket_name, file_name, expiration):
    """Generate a presigned URL for an S3 object."""
    s3 = boto3.client("s3")
    try:
        url = s3.generate_presigned_url(
            "get_object",
            Params={"Bucket": bucket_name, "Key": file_name},
            ExpiresIn=expiration,
        )
        print(f"Pre-signed URL (valid for {expiration} seconds):\n{url}")
        return url
    except Exception as e:
        print(f"Failed to generate presigned URL: {e}")
        exit(1)
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Download, upload to S3, and generate a presigned URL")
    parser.add_argument("file_url", help="URL of the file to download")
    parser.add_argument("bucket_name", help="S3 bucket name (e.g., ds2002-uyn4rh)")
    parser.add_argument("expiration", type=int, help="Presigned URL expiration time (in seconds)")
    args = parser.parse_args()
    file_name = args.file_url.split("/")[-1] 
    download_file(args.file_url, file_name)
    upload_to_s3(file_name, args.bucket_name)
    generate_presigned_url(args.bucket_name, file_name, args.expiration)
